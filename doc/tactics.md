設計方針

*API
**コマンド
コマンドとして出てくるレベルのAPI
-calc 発駅 着駅 経由線・駅
運賃の計算
実質検索とそれに忠実な計算だけが求められる。
特急料金の検索も便利だが、特急の区間の判定が面倒。指定させるべきだけど。
-route 発駅 着駅
発駅と着駅のルートを検索する。
おそらく頑張って自動的にルートを算出してくれるオプションと
（その場合距離の最適化か運賃の最適化か乗り継ぎの最適化かが問題？）
頑張らないオプションが必要。
多分頑張るオプションは後からで大丈夫。
あと、頑張らないにせよ頑張るにせよ、求まったルートを返したり、
求まらなかった場合はどこから先が分からなかったのかを返す必要がある。
**クラス設計
struct Station{
	const unsigned int id;
	const std::string name;
}
struct Line{
	const std::string name;
}
class Route{
	Station start;
	std::vector<std::pair<Line, Station> > path;
}

*データベース
**ER図
描く。
描いた。
**問題点
-会社境界は路線の境界と必ずしも一致しない。そのため路線のパラメータとしての会社は不適切だが、駅個別の属性でもない。正確には隣接駅間の属性である。ただ、あまりにも非効率なので"corp_before"と"corp_after"というカラムを設けて基本はNULLにするというのはどうだろうか？と思ったけど、やっぱり会社を全部の区間に設定して、whereとか使ってで何とかなる気がする。ということで。

*計算規則
**普通運賃の基本
テーブルルックアップ。
-本州3社のみ
--幹線のみ(A)
--地方交通線のみ(B)
--幹線と地方交通線を乗り継ぐ(換算キロ&A, 10km以内ならB)
--電車特定区間(専用表)
--山手線内・環状線内(専用表)
-北海道のみ
--幹線のみ(E)
--地方のみ(F)
--乗り継ぎ(換算キロ&E、10km以内ならF)
-JR四国・JR九州
--幹線のみ(G)
--地方のみ(擬制キロG, H該当ならH)
--乗り継ぎ(擬制キロG, H該当ならI)
-3島会社とまたがって利用
--基準額：全体の運賃
---幹線の利用がある(A)
---地方交通線のみ(B)
--加算額：3島会社の加算運賃
---幹線の利用がある(C)
---北海道の地方交通線のみ(D)

幸運にも3島会社への入り口は1ヶ所だけ＝2回通れない。
加算額は別々に計算して全部合算。
**おまけ
-加算運賃
--関西空港線
--千歳線
--瀬戸大橋線
--宮崎空港線
-特定区間
--瀬戸大橋線
--都会に多い
**経路特定区間
どちらの経路でも短い方の経路で営業キロを算出する。途中下車可能。
         _____
---<__________>
こういうルートだとダメ。以遠-以遠と言う規定。
**東京大環状
東京の中心部を通過するときは最短経路で計算する。途中下車可能。
あらかじめ通過するときの経路を探索して求めておくべき。
**博多小倉
新幹線と在来線で運賃が違う（表が違うから）。往復乗車券も発券可能らしい。
**新幹線原則別線扱い
新幹線は営業キロが等しい物として扱う。ただし特定の区間（余計な駅がある区間）ではそうもいかないので計算する。
東海道線は周遊の時に引っかかるのでまた別問題ながら注意。
**大都市近郊区間特例
最短経路の乗車券で他の経路を通ることができる。裏を返せばちゃんとした経路の乗車券はちゃんと高い。あと、途中下車が許されない。
-東京
-新潟
-大阪
-福岡
**新大阪特例
姫路以遠は新大阪発を大阪発として扱う。
**北新地特例
北新地発尼崎以遠は市内発以外大阪駅発キロで運賃計算、有効期限は正キロ。
**特定都区市内
「中心駅から」201キロメートル以上で特定都区市内。ただし2度出入りすれば単駅。
山の手線内も同類。101キロ以上201キロ以内。
**分岐駅特例
途中下車なしを条件に余計に乗ることができる。
**折り返し区間外乗車
特定の条件で折り返す区間に乗車する時には運賃を払わなくてもよい。
このうち特定の特急に乗車する場合に限り発動するものもある。
ただ、発券時には問題にならないのでスルー。

*使用するSELECT文
あまりにも複雑なのでメモする。
SELECT * FROM kilo,station,line,company where line.id=kilo.line AND kilo.station = station.id AND (line.company = company.id AND line.company != 0 OR line.company=0 AND kilo.company=company.id);

*経路特定に対処する方法
下と似ている。複数区間の経路を探すことが出来れば、それを本来のものに置き換えるだけだ。
ただし、特定運賃と違って途中に挟まっているだけでも検出する必要がある。

*特定運賃に対処する方法
テーブルを具体的に考える。
|id|発駅|着駅|
| 1|東京|千葉|
...

|id|区間発駅|区間着駅|区間路線|
| 1|東京    |千葉    |総武    |

これを結合するテーブルを作る。
ただし、区間テーブルに発駅と着駅を定めるのは汚い気がする。
でもそこから着発駅を除くのも難しい。
まずは汚い手を使うしかないかな。

*wxAresの実装
こっちは運賃をちゃんと計算できるように早くなろう。
運賃を計算するハンドラクラス。
あとあとMARS互換の発駅・着駅・経路指定のハンドラもいるので区別できる名前を.
class AresCalculator
{
protected:
  AresCalculator() = default;
public:
  virtual ares::CFare calcFare() = 0;
  virtual void addSegment(ares::line_id_t, ares::station_id_t, ares::station_id_t) = 0;
  virtual void addSegment(ares::line_id_t) = 0;

};
class AresたどるCalculator : public AresCalculator;
class Ares決められたCalculator : public AresCalculator;
